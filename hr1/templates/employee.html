<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Employee Dashboard</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
 <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>

  <style>
    body { background:#f0f2f5; font-family:Arial, sans-serif; }
    .sidebar{ width:250px; background:#2c3e50; color:white; height:100vh; position:fixed; padding-top:20px; }
    .sidebar .menu-item{ padding:15px 20px; cursor:pointer; }
    .sidebar .menu-item.active, .sidebar .menu-item:hover{ background:#34495e; }
    .main-content{ margin-left:260px; padding:20px; }
    .personal-overview{ display:flex; flex-direction:column; gap:30px; align-items:center; }
    .employee-card, .attendance-card, .leave-card{ padding:20px; border-radius:10px; width:350px; text-align:center; }
    .employee-card img{ width:120px; height:120px; object-fit:cover; border-radius:50%; margin-bottom:10px; }
    #leaveModal{ position:fixed; top:0;left:0; width:100%;height:100%; background:rgba(0,0,0,0.5); display:none; align-items:center; justify-content:center; }
    #leaveModal .modal-content{ background:#fff; padding:20px; border-radius:10px; width:300px; }
    #leaveModal textarea{ width:100%; height:100px; margin-bottom:10px; padding:5px; }
    #leaveModal button{ margin-right:10px; }
    #editModal{ display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); align-items:center; justify-content:center; }
    #editModal .modal-box{ background:#fff; padding:20px; border-radius:10px; width:300px; }
    #editModal input{ width:100%; margin-bottom:10px; padding:5px; }
     /* Light mode (default) */
body {
  background: #ffffff;
  color: #000000;
}

/* Dark mode */
body.dark-mode {
  background: #121212;
  color: #e0e0e0;
}

body.dark-mode .card,
body.dark-mode .employee-card,
body.dark-mode table {
  background: #1e1e1e;
  color: #e0e0e0;
  border-color: #444;
}

body.dark-mode .navbar,
body.dark-mode .sidebar {
  background: #1c1c1c;
  color: #f1f1f1;
}

  </style>
</head>
<body>
 <nav class="navbar">
      <div class="nav-title">Employee Dashboard</div>
      <div class="nav-user">
        <span>Employee</span>
        <button class="logout-btn" onclick="window.location.href='/logout'">Logout</button>
        <button onclick="toggleTheme()" style="margin-right:10px;">üåô/‚òÄÔ∏è</button>
      </div>
    </nav>
  <div class="sidebar">
    <div class="menu-item active" data-page="personal-overview" onclick="setActive(this)">Personal Overview</div>
    <div class="menu-item" data-page="attendance-tracking" onclick="setActive(this)">Attendance Tracking</div>
    <div class="menu-item" data-page="payroll" onclick="setActive(this)">Payroll</div>
    <div class="menu-item" data-page="performance" onclick="setActive(this)">Performance</div>
    <div class="menu-item" data-page="chat" onclick="setActive(this)">Chat</div>
    <div class="menu-item" data-page="calendar" onclick="setActive(this)">Calendar</div>
    <div class="menu-item" data-page="documents" onclick="setActive(this)">Documents</div>

  </div>

  <div class="main-content">
    <div id="page-content"></div>
  </div>

  <!-- Leave Modal -->
  <div id="leaveModal">
    <div class="modal-content">
      <h3>Apply Leave</h3>
      <textarea id="leave-reason" placeholder="Enter reason"></textarea>
      <div>
        <button onclick="submitLeave()">Submit</button>
        <button onclick="closeLeaveModal()">Cancel</button>
      </div>
    </div>
  </div>

  <!-- Edit Profile Modal -->
  <div id="editModal">
    <div class="modal-box">
      <h3>Edit Profile</h3>
      <input id="edit-name" type="text" placeholder="Name">
      <input id="edit-email" type="email" placeholder="Email">
      <input id="edit-role" type="text" placeholder="Role">
      <input id="edit-image" type="file" accept="image/*">
      <input id="edit-documents" type="file" multiple>
      <div>
        <button onclick="submitEdit()">Save</button>
        <button onclick="closeEditModal()">Cancel</button>
      </div>
    </div>
  </div>

<script>
let currentUserId = null;

function setActive(elem){
  document.querySelectorAll('.sidebar .menu-item').forEach(i=>i.classList.remove('active'));
  elem.classList.add('active');
  loadPage(elem.dataset.page);
}

window.onload = () => { loadPage('personal-overview'); }

async function loadPage(page){
  const content = document.getElementById('page-content');

  if(page === 'personal-overview'){
    try{
      const res = await fetch('/api/users');
      const users = await res.json();
      const user = users[0];
      currentUserId = user.id;

      content.innerHTML = `
        <h2>Personal Overview</h2>
        <div class="personal-overview">
          <div class="employee-card">
            <img src="${user.image}" alt="Profile Picture">
            <h4>${user.name}</h4>
            <p><strong>Email:</strong> ${user.email}</p>
            <p><strong>Role:</strong> ${user.role}</p>
            <button onclick="openEditModal(${user.id}, '${user.name}', '${user.email}', '${user.role}')">Edit Profile</button>
          </div>
          <div class="attendance-card">
            <h4>Attendance This Month</h4>
            <canvas id="attendanceChart" width="300" height="300"></canvas>
          </div>
        </div>
      `;
      loadAttendanceChart('attendanceChart','pie'); 
    }catch(err){ content.innerHTML="<p>Error loading profile or chart.</p>"; console.error(err);}
  } 

  else if(page === 'attendance-tracking'){
    const today = new Date();
    const day = today.getDay(); 
    const todayStr = today.toISOString().split('T')[0];
    let infoMsg = day === 0 ? "Today is Sunday. Attendance not allowed." : "Mark your attendance for today.";

    const res2 = await fetch('/api/my_approved_leaves');
    const approvedLeaves = await res2.json();
    let leaveHtml = '';
    if(approvedLeaves.length > 0){
      leaveHtml = `<h4>Approved Leaves</h4>`;
      approvedLeaves.forEach(l => {
        const dateStr = new Date(l.approved_date).toLocaleDateString();
        leaveHtml += `<p>Your leave on ${l.date} was approved on ${dateStr}</p>`;
      });
    }

    content.innerHTML = `
      <h2>Attendance Tracking</h2>
      <p id="today-info">${infoMsg}</p>
      <div id="attendance-buttons" style="margin-bottom:20px;">
        <button id="present-btn" ${day===0?'disabled':''}>Present</button>
        <button id="leave-btn" ${day===0?'disabled':''}>Apply Leave</button>
      </div>
      <div class="attendance-card">
        <h4>Monthly Attendance</h4>
        <canvas id="monthlyChart" width="400" height="300"></canvas>
      </div>
      <div class="leave-card">
        ${leaveHtml}
      </div>
    `;

    document.getElementById('present-btn').onclick = async () => {
      const res = await fetch('/mark_attendance', { 
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify({status:'Present', date: todayStr})
      });
      const data = await res.json();
      alert(data.message);
      loadAttendanceChart('monthlyChart','bar');
    }

    document.getElementById('leave-btn').onclick = () => { 
      document.getElementById('leaveModal').style.display='flex'; 
    }

    loadAttendanceChart('monthlyChart','bar');
  }

  else if(page === 'payroll'){
  try{
    const res = await fetch('/api/my_payroll');
    const payrolls = await res.json();

    let html = `<h2>My Payroll</h2>
      <table border="1" cellpadding="8" cellspacing="0" style="width:100%; text-align:center;">
        <thead>
          <tr>
            <th>Month</th>
            <th>Basic</th>
            <th>Bonus</th>
            <th>Total</th>
            <th>Status</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody>`;

    if(payrolls.length === 0) {
      html += `<tr><td colspan="6" style="text-align:center;">No payroll records found</td></tr>`;
    } else {
      payrolls.forEach(p=>{
        html += `<tr>
          <td>${p.month}</td>
          <td>${p.basic}</td>
          <td>${p.bonus}</td>
          <td>${p.total}</td>
          <td style="color:${p.status==='Paid'?'green':'orange'}; font-weight:bold;">${p.status}</td>
          <td>
            <button onclick="downloadPayslip(${p.id})">Download</button>
          </td>
        </tr>`;
      });
    }

    html += `</tbody></table>`;
    content.innerHTML = html;
  }catch(err){
    content.innerHTML = "<p>Error loading payroll data.</p>";
    console.error(err);
  }
}
 else if(page === 'documents'){
  try{
    const res = await fetch('/api/my_documents');
    const docs = await res.json();

    let html = `<h2>My Documents</h2>
      <table border="1" cellpadding="8" cellspacing="0" style="width:100%; text-align:center; margin-top:10px;">
        <thead><tr><th>Name</th><th>Action</th></tr></thead><tbody>`;

    if(!docs.length){
      html += `<tr><td colspan="2">No documents uploaded</td></tr>`;
    } else {
      docs.forEach(d=>{
        html += `<tr>
          <td>${d.name}</td>
          <td>
            <a href="${d.path}" target="_blank">View</a> |
            <a href="${d.path}" download>Download</a>
          </td>
        </tr>`;
      });
    }

    html += `</tbody></table>`;
    document.getElementById('page-content').innerHTML = html;
  }catch(err){
    console.error('Load documents error:', err);
    document.getElementById('page-content').innerHTML = `<p style="color:red">Error loading documents</p>`;
  }
}


  else if(page === 'performance'){
  content.innerHTML = `
    <h2>Performance</h2>
    <div style="display:flex; gap:30px; flex-wrap:wrap;">
      <div style="flex:1; min-width:300px;">
        <h4>Monthly Attendance Trend</h4>
        <canvas id="performanceAttendanceChart" width="400" height="300"></canvas>
      </div>
      <div style="flex:1; min-width:300px;">
        <h4>Attendance Summary</h4>
        <canvas id="performanceSummaryChart" width="400" height="300"></canvas>
      </div>
    </div>
  `;

  loadPerformanceCharts();
}

  else if(page === 'chat'){
    await loadChatPage(content);
  }
  else if(page === 'calendar'){
  content.innerHTML = `
    <h2>Holiday Calendar</h2>
    <div id="holiday-calendar"></div>
  `;

  fetch('/api/holidays')
    .then(res => res.json())
    .then(holidays => {
      const events = holidays.map(h => ({
        title: h.title,
        start: h.date,
        color: '#f44336' // red for holiday
      }));

      // Sundays as holidays
      const start = new Date(2025, 0, 1); 
      const end = new Date(2025, 11, 31); 
      for (let d = new Date(start); d <= end; d.setDate(d.getDate() + 1)) {
        if (d.getDay() === 0) { 
          events.push({
            title: "Sunday Holiday",
            start: d.toISOString().split('T')[0],
            color: '#2196F3'
          });
        }
      }

      const calendarEl = document.getElementById('holiday-calendar');
      const calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: 'dayGridMonth',
        height: 600,
        events: events
      });

      calendar.render();
    });
}

  else if(page === 'performance'){
    content.innerHTML = `<h2>Performance</h2><p>Coming soon...</p>`;
  }
}


async function loadAttendanceChart(canvasId, type){
  try{
    const res2 = await fetch('/attendance_summary');
    const summary = await res2.json();
    const ctx = document.getElementById(canvasId).getContext('2d');
    new Chart(ctx, {
      type: type,
      data: { labels: ['Present','Absent','Leave'], datasets:[{label:'Days', data:[summary.Present, summary.Absent, summary.Leave], backgroundColor:['#2ecc71','#e74c3c','#f1c40f']}]},
      options:{responsive:true, plugins:{legend:{position:'bottom'}, title:{display:true,text:'Attendance (Current Month)'}}, scales: type==='bar'?{y:{beginAtZero:true, stepSize:1}}:{} }
    });
  }catch(err){ console.error(err); }
}

function closeLeaveModal(){ document.getElementById('leaveModal').style.display='none'; }
async function submitLeave(){
  const reason = document.getElementById('leave-reason').value.trim();
  if(!reason){ alert("Please enter a reason"); return; }
  const todayStr = new Date().toISOString().split('T')[0];
  try{
    const res = await fetch('/apply_leave', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({date: todayStr, reason}) });
    const data = await res.json();
    alert(data.message);
    closeLeaveModal();
    loadPage('attendance-tracking'); 
  }catch(err){ alert("Error submitting leave"); console.error(err); }
}

function openEditModal(id, name, email, role){
  currentUserId = id;
  document.getElementById('edit-name').value = name;
  document.getElementById('edit-email').value = email;
  document.getElementById('edit-role').value = role;
  document.getElementById('edit-image').value = null;
  document.getElementById('editModal').style.display = 'flex';
}

function closeEditModal(){ document.getElementById('editModal').style.display='none'; }

async function submitEdit(){
  const name = document.getElementById('edit-name').value.trim();
  const email = document.getElementById('edit-email').value.trim();
  const role = document.getElementById('edit-role').value.trim();
  const image = document.getElementById('edit-image').files[0];
  const documents = document.getElementById('edit-documents').files;

  if(!name || !email || !role){ alert("All fields are required"); return; }

  const formData = new FormData();
  formData.append('id', currentUserId);
  formData.append('name', name);
  formData.append('email', email);
  formData.append('role', role);
  if(image) formData.append('profile_pic', image);
  if(documents.length > 0){
    for(let i=0; i<documents.length; i++){
      formData.append('documents', documents[i]);
    }
  }

  try{
    const res = await fetch(`/api/update_user/${currentUserId}`, { method:'POST', body: formData });
    const data = await res.json();
    alert(data.message);
    closeEditModal();
    loadPage('personal-overview');
  }catch(err){ alert("Error updating profile"); console.error(err); }
}

// ---------------- Chat Section ----------------
async function loadChatPage(content){
  content.innerHTML = `
    <h2>Employee Chat</h2>
    <select id="chat-user-select"><option value="">Select Employee</option></select>
    <div id="chat-window" style="border:1px solid #ccc; height:300px; overflow-y:auto; padding:10px; margin-top:10px;"></div>
    <textarea id="chat-message" placeholder="Type a message..." rows="2" style="width:100%; margin-top:10px;"></textarea>
    <button id="send-msg-btn">Send</button>
  `;

  try{
    const res = await fetch('/api/chat_users'); 
    const users = await res.json();
    const select = document.getElementById('chat-user-select');

    users.forEach(u=>{
      if(u.id !== currentUserId) select.innerHTML += `<option value="${u.id}">${u.name}</option>`;
    });

    select.onchange = loadMessages;
    document.getElementById('send-msg-btn').onclick = sendMessage;

    setInterval(()=>{ 
      const receiverId = select.value;
      if(receiverId) loadMessages();
    }, 3000);

  }catch(err){ console.error(err); content.innerHTML += "<p>Error loading chat users.</p>"; }
}

async function loadMessages(){
  const receiverId = document.getElementById('chat-user-select').value;
  if(!receiverId) return;
  try{
    const res = await fetch(`/api/chat_messages/${receiverId}`);
    const messages = await res.json();
    const chatWindow = document.getElementById('chat-window');
    chatWindow.innerHTML = '';

    if(!messages || messages.length === 0){
      chatWindow.innerHTML = "<p>No messages yet.</p>";
      return;
    }

    messages.forEach(m=>{
      const div = document.createElement('div');
      div.style.marginBottom = '8px';
      div.style.textAlign = m.sender_id === currentUserId ? 'right' : 'left';
      div.style.background = m.sender_id === currentUserId ? '#d1ffd1' : '#f1f1f1';
      div.style.padding = '5px 10px';
      div.style.borderRadius = '10px';
      div.innerHTML = `<strong>${m.sender_name}:</strong> ${m.message} <br><small>${new Date(m.timestamp).toLocaleString()}</small>`;
      chatWindow.appendChild(div);
    });

    chatWindow.scrollTop = chatWindow.scrollHeight;
  }catch(err){ console.error(err); }
}

async function sendMessage(){
  const receiverId = document.getElementById('chat-user-select').value;
  const msg = document.getElementById('chat-message').value.trim();
  if(!receiverId || !msg) return;
  try{
    const res = await fetch('/api/send_message',{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({receiver_id: receiverId, message: msg})
    });
    const data = await res.json();
    document.getElementById('chat-message').value = '';
    loadMessages();
  }catch(err){ console.error(err); }
}
async function loadPerformanceCharts(){
  try{
    const res = await fetch('/attendance_summary'); 
    const summary = await res.json();

    // Monthly Trend (line chart)
    const res2 = await fetch('/api/attendance_trend'); 
    const trend = await res2.json(); 
    // trend = [{date:"2025-09-01", status:"Present"}, ...]

    const dates = trend.map(t => t.date);
    const values = trend.map(t => t.status === "Present" ? 1 : 0);

    const ctx1 = document.getElementById('performanceAttendanceChart').getContext('2d');
    new Chart(ctx1, {
      type: 'line',
      data: {
        labels: dates,
        datasets: [{
          label: 'Present (1=Yes, 0=No)',
          data: values,
          borderColor: '#2ecc71',
          fill: false,
          tension: 0.3
        }]
      },
      options:{responsive:true, plugins:{legend:{display:false}, title:{display:true,text:'Attendance Trend'}}}
    });

    // Summary (doughnut chart)
    const ctx2 = document.getElementById('performanceSummaryChart').getContext('2d');
    new Chart(ctx2, {
      type: 'doughnut',
      data: {
        labels: ['Present','Absent','Leave'],
        datasets:[{
          data:[summary.Present, summary.Absent, summary.Leave],
          backgroundColor:['#2ecc71','#e74c3c','#f1c40f']
        }]
      },
      options:{responsive:true, plugins:{legend:{position:'bottom'}, title:{display:true,text:'Attendance Summary'}}}
    });

  }catch(err){ console.error(err); }
}
function toggleTheme() {
  document.body.classList.toggle('dark-mode');

  // Save user preference in localStorage
  if (document.body.classList.contains('dark-mode')) {
    localStorage.setItem('theme', 'dark');
  } else {
    localStorage.setItem('theme', 'light');
  }
}

// Page load ayyaka user preference restore cheyyali
window.onload = function() {
  if (localStorage.getItem('theme') === 'dark') {
    document.body.classList.add('dark-mode');
  }
};
function downloadPayslip(payrollId){
    const link = document.createElement('a');
    link.href = `/download_payslip/${payrollId}`;
    link.target = '_blank';  // opens in new tab
    document.body.appendChild(link); // temporarily add to DOM
    link.click();
    document.body.removeChild(link); // clean up
}


</script>
</body>
</html>
