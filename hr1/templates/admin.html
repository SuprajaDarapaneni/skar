<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Dashboard</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>

  <style>
    .employee-list li {
      cursor: pointer;
      color: blue;
      margin-bottom: 5px;
    }
    .employee-list li:hover {
      text-decoration: underline;
    }
    .card {
      background: #f4f4f4;
      padding: 15px;
      border-radius: 10px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      font-size: 16px;
    }
    .employee-card {
      background: #ffffff;
      border-radius: 12px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      padding: 15px;
      width: 250px;
      text-align: center;
    }
    .employee-card img {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      object-fit: cover;
      margin-bottom: 10px;
    }
    .employee-card h4 {
      margin: 5px 0;
    }
    .employee-card p {
      margin: 2px 0;
      font-size: 14px;
      color: #555;
    }
    .employee-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
      gap: 20px;
      margin-top: 20px;
    }
    .status-active {
      color: green;
      font-weight: bold;
    }
    .status-inactive {
      color: red;
      font-weight: bold;
    }
    table {
      border-collapse: collapse;
      width: 100%;
      margin-top: 20px;
    }
    table th, table td {
      border: 1px solid #999;
      padding: 6px 10px;
      text-align: left;
    }
    table th {
      background: #eee;
    }
    /* Light mode (default) */
body {
  background: #ffffff;
  color: #000000;
}

/* Dark mode */
body.dark-mode {
  background: #121212;
  color: #e0e0e0;
}

body.dark-mode .card,
body.dark-mode .employee-card,
body.dark-mode table {
  background: #1e1e1e;
  color: #e0e0e0;
  border-color: #444;
}

body.dark-mode .navbar,
body.dark-mode .sidebar {
  background: #1c1c1c;
  color: #f1f1f1;
}

  </style>
</head>
<body>
  <div id="dashboard" class="dashboard">
    <!-- Navbar -->
    <nav class="navbar">
      <div class="nav-title">Admin Dashboard</div>
      <div class="nav-user">
        <span>Admin</span>
        <button class="logout-btn" onclick="window.location.href='/logout'">Logout</button>
        <button onclick="toggleTheme()" style="margin-right:10px;">üåô/‚òÄÔ∏è</button>
      </div>
      
    </nav>

    <div class="dashboard-content">
      <!-- Sidebar -->
      <aside class="sidebar">
        <div class="menu-item active" onclick="loadPage('overview')">üìä Overview</div>
        <div class="menu-item" onclick="loadPage('employee-management')">üë• Employee Management</div>
        <div class="menu-item" onclick="loadPage('department-management')">üè¢ Department Management</div>
        <div class="menu-item" onclick="loadPage('attendance-leave')">üìÖ Attendance & Leave</div>
        <div class="menu-item" onclick="loadPage('payroll-management')">üí∞ Payroll Management</div>
        <div class="menu-item" onclick="loadPage('reports-analytics')">üìà Reports & Analytics</div>
        <div class="menu-item" onclick="loadPage('work-logs')">üìù Work Logs</div>
        <div class="menu-item" onclick="loadPage('leads-management')">üìãLeads Management</div>
        <div class="menu-item" onclick="loadPage('projects-management')">üìÅ Projects Management</div>
        <div class="menu-item" onclick="loadPage('About')">‚öôÔ∏è About</div>
      </aside>

      <!-- Main Content -->
      <main class="main-content">
        <div id="page-content">
          <h2>Welcome Admin</h2>
          <p>Select an option from the sidebar to manage data.</p>
        </div>
      </main>
    </div>
  </div>

  <!-- JS -->
  <script>
    function loadPage(page) {
      const content = document.getElementById('page-content');

      // ---------------- OVERVIEW ----------------
      if (page === 'overview') {
        fetch('/api/overview_data')
          .then(res => res.json())
          .then(data => {
            content.innerHTML = `
              <h2>Dashboard Overview</h2>
              <div style="display:flex; gap:20px; flex-wrap:wrap; margin-bottom:30px;">
                <div class="card">üë• Total Employees: ${data.total_employees}</div>
                <div class="card">üìÖ Present Today: ${data.present_today}</div>
                <div class="card">üå¥ On Leave: ${data.on_leave}</div>
                <div class="card">üè¢ Departments: ${data.departments}</div>
              </div>
              <div style="display:flex; gap:40px; flex-wrap:wrap;">
                <div style="width:300px;">
                  <h3>Attendance Split</h3>
                  <canvas id="attendancePie"></canvas>
                </div>
                <div style="width:400px;">
                  <h3>Joining Trend</h3>
                  <canvas id="joiningBar"></canvas>
                </div>
              </div>
            `;

            new Chart(document.getElementById('attendancePie'), {
              type: 'pie',
              data: {
                labels: ['Present', 'Absent', 'Leave'],
                datasets: [{
                  data: [data.present_today, data.absent_today, data.on_leave],
                  backgroundColor: ['#4CAF50','#FF5252','#FFC107']
                }]
              }
            });

            new Chart(document.getElementById('joiningBar'), {
              type: 'bar',
              data: {
                labels: data.joining_months,
                datasets: [{label: 'New Employees', data: data.joining_counts, backgroundColor: '#2196F3'}]
              },
              options: { scales: { y: { beginAtZero: true } } }
            });
          });
      }

      // ---------------- EMPLOYEE MANAGEMENT ----------------
      else if (page === 'employee-management') {
        fetch('/api/users').then(res => res.json()).then(users => {
          let html = `
            <div style="display:flex; justify-content:space-between; align-items:center;">
              <h2>Employee Management</h2>
              <button onclick="showAddEmployeeForm()" 
                      style="padding:8px 12px; background:#4CAF50; color:white; border:none; border-radius:6px; cursor:pointer;">
                ‚ûï Add Employee
              </button>
            </div>

            <div id="employee-form" style="display:none; margin-top:20px; background:#f9f9f9; padding:20px; border-radius:10px;">
              <h3 id="form-title">Add New Employee</h3>
              <form onsubmit="saveEmployee(event)">
                <input type="hidden" id="emp-id">
                <input type="text" id="emp-name" placeholder="Name" required><br><br>
                <input type="email" id="emp-email" placeholder="Email" required><br><br>
                <input type="text" id="emp-phone" placeholder="Phone"><br><br>
                <input type="text" id="emp-country" placeholder="Country"><br><br>
                <input type="text" id="emp-role" placeholder="Role"><br><br>
                <input type="password" id="emp-password" placeholder="Enter Password" required>

                <select id="emp-status" required>
                  <option value="active">Active</option>
                  <option value="inactive">Inactive</option>
                </select><br><br>
                <input type="file" id="emp-image"><br><br>
                <button type="submit" style="background:#2196F3; color:white; padding:8px 12px; border:none; border-radius:6px;">Save</button>
              </form>
            </div>

            <div class="employee-grid">
          `;
          users.forEach(u => {
            html += `
              <div class="employee-card">
                <img src="${u.image || '/static/default-avatar.png'}" alt="Profile">
                <h4>${u.name}</h4>
                <p>${u.email}</p>
                <p>üì± ${u.phone || 'N/A'}</p>
                <p>üåç ${u.country || 'N/A'}</p>
                <p class="${u.status === 'active' ? 'status-active' : 'status-inactive'}">
                  ${u.status || 'unknown'}
                </p>
                <p>Role: ${u.role}</p>
                <button onclick="editEmployee(${u.id})" style="background:#FFC107;color:white;border:none;padding:5px 8px;margin:5px;border-radius:5px;">Edit</button>
                <button onclick="deleteEmployee(${u.id})" style="background:#F44336;color:white;border:none;padding:5px 8px;border-radius:5px;">Delete</button>
              </div>
            `;
          });
          html += `</div>`;
          content.innerHTML = html;
        });
      }
     
      // ---------------- ATTENDANCE & LEAVE ----------------
      else if (page === 'attendance-leave') {
        Promise.all([
          fetch('/api/employees').then(r => r.json()),
          fetch('/api/leave_requests').then(r => r.json())
        ]).then(([employees, leaves]) => {
          let html = `<h2>Attendance & Leave</h2>
                      <div style="display:flex; flex-direction:column; gap:30px;">`;

          html += `<div>
                    <h3>Pending Leave Requests</h3>
                    <table>
                      <thead>
                        <tr><th>Name</th><th>Date</th><th>Reason</th><th>Status</th><th>Action</th></tr>
                      </thead>
                      <tbody>`;
          leaves.forEach(lr => {
            html += `<tr>
              <td>${lr.name}</td>
              <td>${lr.leave_date}</td>
              <td>${lr.reason}</td>
              <td>${lr.status}</td>
              <td>${lr.status==='pending' ? `
                  <button onclick="updateLeave(${lr.id}, 'approve')">Approve</button>
                  <button onclick="updateLeave(${lr.id}, 'reject')">Reject</button>` : '-'}</td>
            </tr>`;
          });
          html += `</tbody></table></div>`;

          html += `<div>
                    <h3>Employee Attendance</h3>
                    <ul class="employee-list">`;
          employees.forEach(emp => {
            html += `<li onclick="showAttendanceSummary(${emp.id}, '${emp.name}')">${emp.name}</li>`;
          });
          html += `</ul>
                  <div id="attendance-summary"></div>
                  </div>`;

          html += `</div>`;
          content.innerHTML = html;
        });
      }
      // ---------------- DEPARTMENT MANAGEMENT ----------------
else if (page === 'department-management') {
  fetch('/api/departments')
    .then(res => res.json())
    .then(departments => {
      let html = `
        <div style="display:flex; justify-content:space-between; align-items:center;">
          <h2>Department Management</h2>
          <button onclick="showAddDepartmentForm()" 
                  style="padding:8px 12px; background:#4CAF50; color:white; border:none; border-radius:6px; cursor:pointer;">
            ‚ûï Add Department
          </button>
        </div>

        <div id="department-form" style="display:none; margin-top:20px; background:#f9f9f9; padding:20px; border-radius:10px;">
          <h3 id="department-form-title">Add Department</h3>
          <form onsubmit="saveDepartment(event)">
            <input type="hidden" id="dept-id">
            <input type="text" id="dept-name" placeholder="Department Name" required><br><br>
            <label>Select Employees:</label><br>
            <select id="dept-employees" multiple required style="width:200px; height:100px;"></select><br><br>
            <button type="submit" style="background:#2196F3; color:white; padding:8px 12px; border:none; border-radius:6px;">Save</button>
          </form>
        </div>

        <table style="margin-top:20px;">
          <thead>
            <tr>
              <th>Department</th>
              <th>Employees</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="departmentsTableBody"></tbody>
        </table>
      `;
      content.innerHTML = html;

      // fill table
      const tbody = document.getElementById('departmentsTableBody');
      departments.forEach(d => {
        const empNames = d.employees.map(e => e.name).join(', ') || 'No Employees';
        tbody.innerHTML += `
          <tr>
            <td>${d.name}</td>
            <td>${empNames}</td>
            <td>
              <button onclick="editDepartment(${d.id})" style="background:#FFC107; color:white; border:none; padding:5px 8px; border-radius:5px;">Edit</button>
              <button onclick="deleteDepartment(${d.id})" style="background:#F44336; color:white; border:none; padding:5px 8px; border-radius:5px;">Delete</button>
            </td>
          </tr>
        `;
      });
    });
}

      else if (page==  'About')
        content.innerHTML = `
        <h2>ABOUT</h2>
        <div style="height:1px; background:linear-gradient(90deg, rgba(15,23,36,0.06), rgba(15,23,36,0.02)); margin:10px 0 18px 0;"></div>
        <h3>Company details</h3>
 <h4 style="margin:8px 0; font-size:15px; font-weight:600; color:#0b1220;">
      Company name:
      <span style="font-weight:400; color:#3b4858; margin-left:8px;">SKAR</span>
    </h4>

    <h4 style="margin:8px 0; font-size:15px; font-weight:600; color:#0b1220;">
      Address:
      <span style="font-weight:400; color:#3b4858; margin-left:8px;">Lakdikapul, Hyderabad</span>
    </h4>

    <h4 style="margin:8px 0; font-size:15px; font-weight:600; color:#0b1220;">
      Email:
      <span style="font-weight:400; color:#3b4858; margin-left:8px;">skar2024@gmail.com</span>
    </h4>

    <h4 style="margin:8px 0 0 0; font-size:15px; font-weight:600; color:#0b1220;">
      Phone number:
      <span style="font-weight:400; color:#3b4858; margin-left:8px;">9999999999</span>
    </h4>
    </div>
      
      `;
      // ---------------- PAYROLL MANAGEMENT ----------------
else if (page === 'payroll-management') {
  fetch('/api/payroll')
    .then(r => r.json())
    .then(payrolls => {
      let html = `
        <h2>Payroll Management</h2>
        <form onsubmit="savePayroll(event)" style="margin-bottom:20px;">
          <select id="payroll-employee" required>
            <option value="">Select Employee</option>
          </select>
          <input type="month" id="payroll-month" required>
          <input type="number" id="payroll-basic" placeholder="Basic Salary" required>
          <input type="number" id="payroll-bonus" placeholder="Bonus" required>
          <button type="submit">Save Payroll</button>
        </form>
        <button onclick="downloadPayrollPDF()" 
        style="margin-bottom:15px; padding:8px 12px; background:#4CAF50; color:white; border:none; border-radius:6px;">
  üìÑ Download PDF
</button>

        <table>
          <thead>
            <tr><th>Employee</th><th>Month</th><th>Basic</th><th>Bonus</th><th>Total</th><th>Status</th><th>Actions</th></tr>
          </thead>
          <tbody>`;
      payrolls.forEach(p => {
        html += `
          <tr>
            <td>${p.employee_name}</td>
            <td>${p.month}</td>
            <td>${p.basic}</td>
            <td>${p.bonus}</td>
            <td>${p.total}</td>
            <td>${p.status}</td>
            <td>
              <button onclick="updatePayrollStatus(${p.id}, 'paid')">Mark Paid</button>
              <button onclick="deletePayroll(${p.id})">Delete</button>
            </td>
          </tr>`;
      });
      html += `</tbody></table>`;
      content.innerHTML = html;

      // Load employees into dropdown
      fetch('/api/users').then(r => r.json()).then(users => {
        let empSelect = document.getElementById('payroll-employee');
        users.forEach(u => {
          empSelect.innerHTML += `<option value="${u.id}">${u.name}</option>`;
        });
      });
    });
}
      else if(page === 'projects-management') {
    content.innerHTML = `
      <h2>Projects Management</h2>
      <button onclick="showAddProjectForm()" style="padding:8px 12px; background:#4CAF50; color:white; border:none; border-radius:6px;">‚ûï Add Project</button>
      <div id="project-form" style="display:none; margin-top:20px; background:#f9f9f9; padding:20px; border-radius:10px;">
        <h3 id="project-form-title">Add Project</h3>
        <form onsubmit="saveProject(event)">
          <input type="hidden" id="project-id">
          <input type="text" id="project-name" placeholder="Project Name" required><br><br>
          <input type="text" id="project-status" placeholder="Status (Active/Inactive)" required><br><br>
          <input type="text" id="project-priority" placeholder="Priority (High/Medium/Low)"><br><br>
          <textarea id="project-desc" placeholder="Description"></textarea><br><br>
          <select id="project-employees" multiple required style="width:200px; height:80px;">
  <!-- employees will be loaded dynamically -->
</select><br><br>

          <button type="submit" style="background:#2196F3;color:white;padding:8px 12px;border:none;border-radius:6px;">Save</button>
        </form>
      </div>
      <table id="projectsTable">
        <thead><tr><th>Name</th><th>Status</th><th>Priority</th><th>Description</th><th>Assigned To</th><th>Actions</th></tr></thead>
        <tbody></tbody>
      </table>
    `;
    loadProjects();
}
    else if (page === 'leads-management') {
  fetch('/api/leads').then(r=>r.json()).then(leads=>{
    let html=`
      <h2>Leads Management</h2>
      <button onclick="showAddLeadForm()" style="background:#4CAF50;color:white;margin:5px;">‚ûï Add Lead</button>
      <button onclick="showUploadCSVForm()" style="background:#FF9800;color:white;margin:5px;">‚¨Ü Upload CSV</button>

      <div id="file-upload-form" style="display:none;margin-top:20px;padding:15px;border:1px solid #ccc;border-radius:10px;">
        <h3>Upload CSV/XLSX</h3>
        <form id="uploadForm" enctype="multipart/form-data">
          <input type="file" name="file" required><br><br>
          <button type="submit" style="background:#2196F3;color:white;">Upload</button>
        </form>
      </div>

      <div id="lead-form" style="display:none;margin-top:20px;padding:15px;border:1px solid #ccc;border-radius:10px;">
        <h3>Add New Lead</h3>
        <form onsubmit="saveLead(event)">
          <input type="text" id="lead-name" placeholder="Name" required><br><br>
          <input type="email" id="lead-email" placeholder="Email"><br><br>
          <input type="text" id="lead-phone" placeholder="Phone"><br><br>
          <input type="text" id="lead-source" placeholder="Source"><br><br>
          <button type="submit" style="background:#2196F3;color:white;">Save</button>
        </form>
      </div>

      <table>
        <thead><tr><th>Name</th><th>Email</th><th>Phone</th><th>Source</th><th>Actions</th></tr></thead>
        <tbody id="leads_table_body"></tbody>
      </table>`;
    
    content.innerHTML = html;
setTimeout(() => renderLeads(leads), 0);

  });
}

      else if(page === 'work-logs') {
    content.innerHTML = `
      <h2>Work Logs</h2>
      <label>Select Month:</label>
      <input type="month" id="worklog-month" onchange="loadWorkLogs()">
      <button onclick="downloadWorkLogsPDF()" style="margin-left:10px;padding:6px 12px;background:#4CAF50;color:white;border:none;border-radius:6px;">üìÑ Download PDF</button>
      <table>
        <thead>
          <tr>
            <th>Name</th>
            <th>Date</th>
            <th>Clock In</th>
            <th>Clock Out</th>
          </tr>
        </thead>
        <tbody id="worklogs-body"></tbody>
      </table>
    `;
    loadWorkLogs(); // default load
}
      
      // ---------------- REPORTS & ANALYTICS ----------------
      else if (page === 'reports-analytics') {
        content.innerHTML = `
          <h2>Reports & Analytics</h2>
          <div class="attendance-report">
            <h3>Attendance Report</h3>
            <div style="margin-bottom:15px;">
              <button onclick="loadReport('daily')" style="padding:6px 12px; margin-right:10px;">Daily</button>
              <button onclick="loadReport('weekly')" style="padding:6px 12px; margin-right:10px;">Weekly</button>
              <button onclick="loadReport('monthly')" style="padding:6px 12px;">Monthly</button>
            </div>
            <canvas id="reportChart" width="500" height="300"></canvas>
          </div>
        `;
        loadReport('daily'); // load daily by default
      }

      else {
        content.innerHTML = `<h2>${page.replace('-', ' ')}</h2><p>Content coming soon...</p>`;
      }
    }

    function showAttendanceSummary(id, name) {
      fetch(`/api/attendance/${id}`)
        .then(res => res.json())
        .then(records => {
          if (!records || records.length === 0) {
            document.getElementById('attendance-summary').innerHTML = `<p>No attendance data for ${name}</p>`;
            return;
          }

          let present = records.filter(r => r.status === 'Present').length;
          let absent = records.filter(r => r.status === 'Absent').length;
          let leave = records.filter(r => r.status === 'Leave').length;

          document.getElementById('attendance-summary').innerHTML = `
            <h3>${name}'s Attendance Summary</h3>
            <canvas id="empAttendanceChart" width="400" height="200"></canvas>
          `;

          new Chart(document.getElementById('empAttendanceChart'), {
            type: 'bar',
            data: {
              labels: ['Present', 'Absent', 'Leave'],
              datasets: [{
                label: 'Attendance Count',
                data: [present, absent, leave],
                backgroundColor: ['#4CAF50','#FF5252','#FFC107']
              }]
            },
            options: {
              scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } }
            }
          });
        });
    }

    function showAddEmployeeForm() {
      document.getElementById('form-title').textContent = "Add New Employee";
      document.getElementById('employee-form').style.display = 'block';
      document.getElementById('emp-id').value = '';
      document.getElementById('emp-name').value = '';
      document.getElementById('emp-email').value = '';
      document.getElementById('emp-phone').value = '';
      document.getElementById('emp-country').value = '';
      document.getElementById('emp-role').value = '';
      document.getElementById('emp-status').value = 'active';
      document.getElementById('emp-image').value = '';
    }

    function editEmployee(id) {
      fetch('/api/users/' + id)
        .then(res => res.json())
        .then(u => {
          document.getElementById('form-title').textContent = "Edit Employee";
          document.getElementById('employee-form').style.display = 'block';
          document.getElementById('emp-id').value = u.id;
          document.getElementById('emp-name').value = u.name;
          document.getElementById('emp-email').value = u.email;
          document.getElementById('emp-phone').value = u.phone;
          document.getElementById('emp-country').value = u.country;
          document.getElementById('emp-role').value = u.role;
          document.getElementById('emp-status').value = u.status;
        });
    }

    function saveEmployee(event) {
      event.preventDefault();
      const formData = new FormData();
      const id = document.getElementById('emp-id').value;

      formData.append('name', document.getElementById('emp-name').value);
      formData.append('email', document.getElementById('emp-email').value);
      formData.append('phone', document.getElementById('emp-phone').value);
      formData.append('country', document.getElementById('emp-country').value);
      formData.append('role', document.getElementById('emp-role').value);
      formData.append('status', document.getElementById('emp-status').value);
      formData.append('password', document.getElementById('emp-password').value);

      if (document.getElementById('emp-image').files[0]) {
        formData.append('profile_pic', document.getElementById('emp-image').files[0]);
      }

      fetch(id ? '/api/update_user/' + id : '/add_employee', {
        method: 'POST',
        body: formData
      })
      .then(res => res.json())
      .then(result => {
        alert(result.message);
        loadPage('employee-management');
      });
    }

    function deleteEmployee(id) {
      if (!confirm('Are you sure you want to delete this employee?')) return;
      fetch('/api/delete_user/' + id, { method: 'DELETE' })
        .then(res => res.json())
        .then(result => {
          alert(result.message);
          loadPage('employee-management');
        });
    }

    function updateLeave(id, action) {
      fetch('/api/leave_requests/' + id, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({action})
      }).then(res => res.json())
        .then(result => {
          alert(result.message);
          loadPage('attendance-leave');
        });
    }

    async function loadReport(type){
      const res = await fetch(`/admin/attendance_report?type=${type}`);
      const summary = await res.json();

      const ctx = document.getElementById('reportChart').getContext('2d');
      if (window.reportChartInstance) {
        window.reportChartInstance.destroy();
      }

      window.reportChartInstance = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: ['Present', 'Absent', 'Leave'],
          datasets: [{
            label: `${type.charAt(0).toUpperCase() + type.slice(1)} Attendance`,
            data: [summary.Present, summary.Absent, summary.Leave],
            backgroundColor: ['#4CAF50','#FF5252','#FFC107']
          }]
        },
        options: {
          responsive: true,
          plugins:{ legend:{ display:false } },
          scales: { y: { beginAtZero: true, ticks:{ stepSize:1 } } }
        }
      });
    }
    function savePayroll(event){
  event.preventDefault();
  const formData={
    user_id: document.getElementById('payroll-employee').value,
    month: document.getElementById('payroll-month').value,
    basic: parseFloat(document.getElementById('payroll-basic').value),
    bonus: parseFloat(document.getElementById('payroll-bonus').value)
  };
  formData.total=formData.basic+formData.bonus;
  fetch('/api/payroll',{method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(formData)})
    .then(r=>r.json()).then(r=>{ alert(r.message); loadPage('payroll-management'); });
}

function deletePayroll(id){
  if(!confirm('Delete this payroll?')) return;
  fetch('/api/payroll/'+id,{method:'DELETE'}).then(r=>r.json()).then(r=>{ alert(r.message); loadPage('payroll-management'); });
}

function updatePayrollStatus(id,status){
  fetch('/api/payroll_status/'+id,{method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({status})})
    .then(r=>r.json()).then(r=>{ alert(r.message); loadPage('payroll-management');¬†});
}
function downloadPayrollPDF() {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();

  doc.setFontSize(16);
  doc.text("Payroll Report", 14, 20);

  // Get table data
  const rows = [];
  document.querySelectorAll('table tbody tr').forEach(tr => {
    const row = [];
    tr.querySelectorAll('td').forEach(td => row.push(td.innerText));
    rows.push(row);
  });

  doc.autoTable({
    head: [['Employee', 'Month', 'Basic', 'Bonus', 'Total', 'Status']],
    body: rows,
    startY: 30,
    styles: { fontSize: 10 },
  });

  doc.save('payroll_report.pdf');
}
async function loadProjects() {
    const tbody = document.querySelector('#projectsTable tbody');
    tbody.innerHTML = '';
    const res = await fetch('/api/projects');
    const projects = await res.json();
    projects.forEach(p => {
    tbody.innerHTML += `<tr>
        <td>${p.name}</td>
        <td>${p.status}</td>
        <td>${p.priority}</td>
        <td>${p.description}</td>
        <td>${p.assigned_to}</td>
        <td>
          <button onclick="editProject(${p.id})">Edit</button>
          <button onclick="deleteProject(${p.id})">Delete</button>
        </td>
    </tr>`;
});

}

function showAddProjectForm() {
    document.getElementById('project-form-title').textContent = "Add Project";
    document.getElementById('project-form').style.display = 'block';
    document.getElementById('project-id').value = '';
    document.getElementById('project-name').value = '';
    document.getElementById('project-status').value = '';
    document.getElementById('project-priority').value = '';
    document.getElementById('project-desc').value = '';

    // Clear previous options
    const selectElement = document.getElementById('project-employees');
    selectElement.innerHTML = '';

    // Load employees into dropdown
    fetch('/api/users/all')
      .then(res => res.json())
      .then(users => {
          users.forEach(u => {
              const option = document.createElement('option');
              option.value = u.id;
              option.text = u.name;
              selectElement.appendChild(option);
          });
      });
}


function saveProject(event, id = null) {
    event.preventDefault();
    const selectedEmployees = Array.from(
        document.getElementById('project-employees').selectedOptions
    ).map(o => o.value); // array of employee IDs

    const data = {
        name: document.getElementById('project-name').value,
        status: document.getElementById('project-status').value,
        priority: document.getElementById('project-priority').value,
        description: document.getElementById('project-desc').value,
        employees: selectedEmployees
    };

    fetch(id ? '/api/projects/' + id : '/api/projects', {
        method: id ? 'PUT' : 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
    })
    .then(res => res.json())
    .then(result => {
        alert(result.message);
        loadProjects();
        document.getElementById('project-form').style.display = 'none';
    });
}


function deleteProject(id) {
    if (confirm("Are you sure you want to delete this project?")) {
        fetch('/api/projects/' + id, { method: 'DELETE' })
            .then(res => res.json())
            .then(result => {
                alert(result.message);
                loadProjects();
            });
    }
}
function editProject(id) {
  fetch('/api/projects/' + id)
    .then(res => res.json())
    .then(project => {
      document.getElementById('project-form-title').textContent = "Edit Project";
      document.getElementById('project-form').style.display = 'block';
      document.getElementById('project-id').value = project.id;
      document.getElementById('project-name').value = project.name;
      document.getElementById('project-desc').value = project.description;
      document.getElementById('project-status').value = project.status;
      document.getElementById('project-priority').value = project.priority;

      let selectedIds = [];
      if (Array.isArray(project.employees)) {
        if (typeof project.employees[0] === "object") {
          selectedIds = project.employees.map(e => e.id);
        } else {
          selectedIds = project.employees;
        }
      }

      loadEmployeesForProject(selectedIds);
    })
    .catch(err => {
      alert("Failed to load project data. " + err);
    });
}

function loadEmployeesForProject(selectedIds) {
  const select = document.getElementById('project-employees');
  select.innerHTML = '';
  fetch('/api/users')
    .then(res => res.json())
    .then(users => {
      users.forEach(u => {
        const option = document.createElement('option');
        option.value = u.id;
        option.text = u.name;
        if (selectedIds.includes(u.id)) option.selected = true;
        select.appendChild(option);
      });
    });
}

function showAddDepartmentForm() {
  document.getElementById('department-form-title').textContent = "Add Department";
  document.getElementById('department-form').style.display = 'block';
  document.getElementById('dept-id').value = '';
  document.getElementById('dept-name').value = '';
  loadEmployeesForDepartment([]);
}

function loadEmployeesForDepartment(selectedIds) {
  const select = document.getElementById('dept-employees');
  select.innerHTML = '';
  fetch('/api/users')
    .then(res => res.json())
    .then(users => {
      users.forEach(u => {
        const option = document.createElement('option');
        option.value = u.id;
        option.text = u.name;
        if (selectedIds.includes(u.id)) option.selected = true;
        select.appendChild(option);
      });
    });
}

function saveDepartment(event) {
  event.preventDefault();
  const id = document.getElementById('dept-id').value;
  const name = document.getElementById('dept-name').value;
  const employees = Array.from(document.getElementById('dept-employees').selectedOptions).map(o => o.value);

  fetch(id ? '/api/departments/' + id : '/api/departments', {
    method: id ? 'PUT' : 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ name, employees })
  })
  .then(res => res.json())
  .then(result => {
    alert(result.message);
    loadPage('department-management');
  });
}

function editDepartment(id) {
  fetch('/api/departments/' + id)
    .then(res => res.json())
    .then(d => {
      document.getElementById('department-form-title').textContent = "Edit Department";
      document.getElementById('department-form').style.display = 'block';
      document.getElementById('dept-id').value = d.id;
      document.getElementById('dept-name').value = d.name;
      loadEmployeesForDepartment(d.employees.map(e => e.id));
    });
}

function deleteDepartment(id) {
  if (!confirm("Are you sure you want to delete this department?")) return;
  fetch('/api/departments/' + id, { method: 'DELETE' })
    .then(res => res.json())
    .then(result => {
      alert(result.message);
      loadPage('department-management');
    });
}
function loadWorkLogs() {
    const month = document.getElementById('worklog-month').value; // "YYYY-MM"
    if (!month) return; // Month select cheyyakapothe return

    fetch('/api/work_logs?month=' + month)
        .then(res => res.json())
        .then(data => {
            let html = '';
            if (data.length === 0) {
                html = `<tr><td colspan="4" style="text-align:center;">No work logs for this month</td></tr>`;
            } else {
                data.forEach(log => {
                    html += `<tr>
                        <td>${log.name}</td>
                        <td>${log.log_date}</td>
                        <td>${log.clock_in}</td>
                        <td>${log.clock_out}</td>
                    </tr>`;
                });
            }
            document.getElementById('worklogs-body').innerHTML = html; // populate tbody
        })
        .catch(err => {
            console.error('Error loading work logs:', err);
            document.getElementById('worklogs-body').innerHTML = `<tr><td colspan="4" style="text-align:center;">Error loading data</td></tr>`;
        });
}


function downloadWorkLogsPDF() {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();
  doc.setFontSize(16);
  doc.text("Work Logs Report", 14, 20);

  const rows = [];
  document.querySelectorAll('#worklogs-body tr').forEach(tr => {
    const row = [];
    tr.querySelectorAll('td').forEach(td => row.push(td.innerText));
    rows.push(row);
  });

  doc.autoTable({
    head: [['Name','Date','Clock In','Clock Out']],
    body: rows,
    startY: 30,
    styles: { fontSize: 10 },
  });

  doc.save('work_logs_report.pdf');
}

function loadEmployeesForProject(selectedIds) {
  const select = document.getElementById('project-employees');
  select.innerHTML = '';
  fetch('/api/users')
    .then(res => res.json())
    .then(users => {
      users.forEach(u => {
        const option = document.createElement('option');
        option.value = u.id;
        option.text = u.name;
        if (selectedIds.includes(u.id)) option.selected = true;
        select.appendChild(option);
      });
    });
}

function renderLeads(leads){
  const tbody=document.getElementById('leads_table_body');
  tbody.innerHTML='';
  leads.forEach(l=>{
    let tr=document.createElement('tr');
    tr.innerHTML=`<td>${l.name}</td><td>${l.email||'-'}</td><td>${l.phone||'-'}</td><td>${l.source||'-'}</td>
      <td>
        <button onclick="editLead(${l.id})" style="background:#FFC107;color:white;">Edit</button>
        <button onclick="deleteLead(${l.id})" style="background:#F44336;color:white;">Delete</button>
      </td>`;
    tbody.appendChild(tr);
  });
}

function showAddLeadForm(){document.getElementById('lead-form').style.display='block';}
function showUploadCSVForm(){document.getElementById('file-upload-form').style.display='block';}

function saveLead(e){
  e.preventDefault();
  const data={
    name:document.getElementById('lead-name').value,
    email:document.getElementById('lead-email').value,
    phone:document.getElementById('lead-phone').value,
    source:document.getElementById('lead-source').value,
    status:"Active"
  };
  fetch('/api/leads',{
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify(data)
  }).then(r=>r.json()).then(res=>{
    alert(res.message);
    loadPage('leads-management');
  });
}

function editLead(id){
  const name=prompt("Enter new name");
  if(!name) return;
  const email=prompt("Enter new email")||'';
  const phone=prompt("Enter new phone")||'';
  const source=prompt("Enter new source")||'';
  fetch('/edit_lead/'+id,{
    method:'PUT',
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify({name,email,phone,source})
  }).then(r=>r.json()).then(d=>{
    alert(d.message);
    loadPage('leads-management');
  });
}

function deleteLead(id){
  if(!confirm("Are you sure?")) return;
  fetch('/delete_lead/'+id,{method:'DELETE'}).then(r=>r.json()).then(d=>{
    alert(d.message);
    loadPage('leads-management');
  });
}

function attachUploadListener(){
  const uploadForm=document.getElementById('uploadForm');
  if(!uploadForm) return;
  uploadForm.addEventListener('submit',function(e){
    e.preventDefault();
    const formData=new FormData(this);
    fetch('/upload_file',{method:'POST',body:formData})
      .then(r=>r.json())
      .then(d=>{
        alert(d.message);
        loadPage('leads-management');
      });
  });
}function toggleTheme() {
  document.body.classList.toggle('dark-mode');

  // Save user preference in localStorage
  if (document.body.classList.contains('dark-mode')) {
    localStorage.setItem('theme', 'dark');
  } else {
    localStorage.setItem('theme', 'light');
  }
}

// Page load ayyaka user preference restore cheyyali
window.onload = function() {
  if (localStorage.getItem('theme') === 'dark') {
    document.body.classList.add('dark-mode');
  }
};
  </script>
</body>
</html>
